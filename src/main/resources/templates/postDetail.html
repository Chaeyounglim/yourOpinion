<!DOCTYPE HTML>
<html lang="ko">
<head>
    <title>너의 의견은.</title>
    <link rel="shortcut icon" href="#">

    <!-- ajax , cookies 사용 lib -->
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <!-- ajax , cookies 사용 lib -->

    <!--    alert 창 import-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    <link rel='stylesheet' href="/css/votestyle.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">


    addEventListener("load", function () {
    setTimeout(hideURLbar, 0);
    }, false);

    function hideURLbar() {
    window.scrollTo(0, 1);
    } </script>


    <!--    Button css-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
    <!--    Button css-->

    <!----webfonts---->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700,800' rel='stylesheet' type='text/css'>
    <!----//webfonts---->
    <!---start-click-drop-down-menu----->
    <script src="/js/single-page/jquery.min.js"></script>
    <!----//End-dropdown--->

    <style>
        a.list-group-item {
            height: auto;
            min-height: 220px;
        }

        a.list-group-item.active small {
            color: #fff;
        }

        a.list-group-item .vs-title {
            font-size: 110px;
        }

        .fa {
            font-size: 100px;
            color: #ffffff;
        }

        .social a {
            text-decoration: none;
        }

        .twitter {
            background-color: #00acee;
            border-radius: 4px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .facebook-like {
            background-color: #3b5998;
            border-radius: 4px;
            margin-top: -3px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .media {
            padding: 10px;
        }
    </style>

</head>

<body>
<div class="header">
    <button type="button" class="btn btn-secondary" onclick="location.href='/'" style="margin: 20px;">
        Back
    </button>
    <div class="wrap">
        <div class="clear"></div>
    </div>
</div>
<!---//End-header---->
<!---start-content---->
<div class="content" style="background: url('https://images3.alphacoders.com/764/764967.png');">
    <div class="wrap">
        <div class="single-page">
            <div class="single-page-artical">
                <div class="artical-content">


                    <div class="row form-group">
                        <div class="col-md-12" style="width: 95%;text-align: left;">
                            <div>
                                <label class="text-black h4">작성자</label> :
                                <label class="text-black h4"
                                       th:text="${post.nickname} + ' (' + ${post.username} +')' "></label>
                            </div>
                            <div style="float:right;">
                                <label class="text-black h4">작성일자</label> :
                                <label class="text-black h4"
                                       th:text="${#temporals.format(post.modifiedAt, 'yyyy-MM-dd HH:mm:ss')}"></label>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="container bootstrap snippets bootdey" style="width: 100%;">
                            <div class="row">
                                <div class="voteBack">
                                <div class="well" style="background-color: unset; border:0px;">
                                        <h1 class="text-center">
                                            <b><span th:text="${post.title}"></span></b>
                                        </h1>
                                        <br/>
                                        <p th:text="${post.content}"></p>

                                        <div class="list-group">
                                            <a href="#" class="list-group-item" style="background: rgba(0,0,0,0)">
                                                <div class="col-md-3">
                                                    <div class="media col-md-12 twitter">
                                                        <figure class="pull-left">
                                                            <i class="fa fa-twitter"></i>
                                                        </figure>
                                                    </div>
                                                    <div class="media col-md-12">
                                                        <button type="button"
                                                                class="btn btn-default btn-lg btn-block"><span
                                                                th:text="${post.opinionA}"></span></button>
                                                        <button type="button"
                                                                class="btn btn-default btn-lg btn-block"><span
                                                                th:text="${post.opinionACnt}"></span></button>

                                                    </div>
                                                </div>
                                                <div class="col-md-6 text-center">
                                                    <h1 class="vs-title">VS</h1>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="media col-md-12 facebook-like">
                                                        <figure class="pull-left">
                                                            <i class="fa fa-facebook"></i>
                                                        </figure>
                                                    </div>
                                                    <div class="media col-md-12">
                                                        <button type="button"
                                                                class="btn btn-default btn-lg btn-block"><span
                                                                th:text="${post.opinionB}"></span></button>
                                                        <button type="button"
                                                                class="btn btn-default btn-lg btn-block"><span
                                                                th:text="${post.opinionBCnt}"></span></button>

                                                    </div>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                    <div style="width: 57%;">
                                        <button type="button" class="btn btn-secondary" id="editBtn"
                                                style="margin-left: 20px;float: right;">수정
                                        </button>
                                        <button type="button" class="btn btn-secondary" id="deleteBtn"
                                                style="margin-left: 20px;float: right;">삭제
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>

                <div class="clear"></div>
            </div>
            <!---start-comments-section--->
            <br/><br/><br/><br/><br/>

            <div class="comment-section" style="padding:30px;">
                <div class="grids_of_2">
                    <hr style="border-top: 1px solid #000;">
                    <h2>Comments</h2>
                    <div class="grid1_of_2">
                        <div class="grid_text">
                            <h4 class="style1 list" th:text="${post.getCommentResponseDtoList().get(0).nickname}"></h4>
                            <h3 class="style" style="margin-top:0px;"
                                th:text="${post.getCommentResponseDtoList().get(0).getModifiedAt()}">march 3, 2013 -
                                4.00 PM</h3>
                            <p class="para top" th:text="${post.getCommentResponseDtoList().get(0).getContent()}">
                                All the Lorem Ipsum generators on the Internet tend to repeat
                                predefined chunks as necessary, making this the first true generator on the Internet. It
                                uses a dictionary of over 200 Latin words, combined with a handful of model sentence
                                structures, to generate Lorem Ipsum which looks reasonable.</p>
                            <a href="#" class="btn1">수정</a>
                            <a href="#" class="btn1">삭제</a>
                            <a href="" class="btn1">Reply</a>
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="grid1_of_2 left">
                        <div class="grid_text">
                            <h4 class="style1 list" th:text="${post.getCommentResponseDtoList().get(0).nickname}"></h4>
                            <h3 class="style" style="margin-top:0px;"
                                th:text="${post.getCommentResponseDtoList().get(0).getModifiedAt()}">march 3, 2013 -
                                4.00 PM</h3>
                            <p class="para top" th:text="${post.getCommentResponseDtoList().get(0).getContent()}">
                                All the Lorem Ipsum generators on the Internet tend to repeat
                                predefined chunks as necessary, making this the first true generator on the Internet. It
                                uses a dictionary of over 200 Latin words, combined with a handful of model sentence
                                structures, to generate Lorem Ipsum which looks reasonable.</p>
                            <a href="#" class="btn1" id="comEditBtn">수정</a>
                            <a href="" class="btn1" id="comDeleteBtn">삭제</a>
                            <a href="" class="btn1" id="replyBtn">Reply</a>
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="grid1_of_2">
                        <div class="grid_text">
                            <h4 class="style1 list"><a href="#">Ro Kanth</a></h4>
                            <h3 class="style">march 2, 2013 - 12.50 AM</h3>
                            <p class="para top"> All the Lorem Ipsum generators on the Internet tend to repeat
                                predefined chunks as necessary, making this the first true generator on the Internet. It
                                uses a dictionary of over 200 Latin words, combined with a handful of model sentence
                                structures, to generate Lorem Ipsum which looks reasonable.</p>
                            <a href="" class="btn1">Click to Reply</a>
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="artical-commentbox">
                        <h2>Leave a Comment</h2>
                        <div class="table-form">
                            <form action="#" method="post" name="post_comment">
                                <div>
                                    <label>Name<span>*</span></label>
                                    <h4 th:text="${post.nickname}"></h4>
                                </div>
                                <div>
                                    <label>Your Comment<span>*</span></label>
                                    <textarea id="InputContent"> </textarea>
                                </div>
                            </form>
                            <button class="btn btn-secondary" type="button" id="comCreateBtn">댓글 작성</button>
                        </div>
                        <div class="clear"></div>
                    </div>
                </div>
            </div>
            <!---//End-comments-section--->
        </div>
    </div>
</div>
<!----start-footer--->
<div class="footer">
    <p>Design by <a href="http://w3layouts.com/">W3layouts</a></p>
</div>
</body>

<script th:inline="javascript">
    // 게시글 id를 model 객체에서 가져와서 저장.
    const postId = [[${post.id}]];

    // 게시글 수정 버튼 클릭 시
    $('#editBtn').click(function () {
        window.location.href = "/api/post/modify-page/" + postId;
    });

    // 게시글 삭제 버튼 클릭 시
    $('#deleteBtn').click(function () {
        const isConfirmed = confirm("정말로 삭제하시겠습니까?");
        if (isConfirmed) {
            const url = "/api/posts/" + postId;
            deletePost(url);
        }
    });

    // 댓글 작성 버튼
    $('#comCreateBtn').click(function () {
        const commentUrl = "/api/posts/" + postId + "/comment"; // 댓글 작성 url
        createComment(commentUrl);
    })

    // 댓글 수정 버튼 클릭 시
    $('#comEditBtn').click(function () {
        commentEdit(); // 함수 만들어야 함. 어떤 댓글인지 id 값이 필요
    });

    // 댓글 삭제 버튼 클릭 시
    $('#comDeleteBtn').click(function () {
        const isConfirmed = confirm("정말로 삭제하시겠습니까?");
        if (isConfirmed) {
            // const url = window.location.href = "/api/comments/" + commentId;
            commentDelete(); // 함수 만들어야 함. 어떤 댓글인지 id 값이 필요
        }
    });

    // Reply 버튼 클릭 시
    $('#replyBtn').click(function () {
        createReply(); // 함수 만들어야 함. 어떤 댓글인지 id 값이 필요
    });

    $(document).ready(function () {
        const token = Cookies.get('Authorization');

        if (token) {
            $.ajaxPrefilter(function (options, originalOptions, jqXHR) {
                jqXHR.setRequestHeader('Authorization', token);
            });
            displayBtn(token);
        } else {
            console.log('로그인이 안 되어있습니다.');
        }
    })


    // 게시글 삭제, 수정 버튼은 작성자에게만 활성화
    function displayBtn(token) {
        const editBtn = document.getElementById('editBtn');
        const deleteBtn = document.getElementById('deleteBtn');

        const payload = JSON.parse(atob(token.split(".")[1]));
        const loginUsername = payload.sub; // 로그인한 id
        const writerUsername = [[${post.username}]]; // 게시글 작성자

        // 게시글 작성자일 경우
        if (loginUsername === writerUsername) {
            // 수정, 삭제 버튼 활성화
            editBtn.style.display = 'block';
            deleteBtn.style.display = 'block';
        } else {
            // 수정, 삭제 버튼 활성화
            editBtn.style.display = 'none';
            deleteBtn.style.display = 'none';
        }
    }

    // 게시글 삭제하기
    function deletePost(url) {
        const token = Cookies.get('Authorization');

        $.ajax({
            url: url,
            type: "DELETE",
            dataType: "json",
            headers: {              // Http header
                "Content-Type": "application/json",
                "Authorization": token
            },
            success: function (data) {
                Swal.fire({
                        icon: 'success',
                        title: '삭제 성공',
                        text: '게시글 삭제가 성공적으로 완료되었습니다.'
                    }
                ).then(function () {
                    window.location.href = "/";
                })
            },
            error: function (error) {

                Toast.fire({
                    icon: 'error',
                    title: '삭제 실패',
                    text: '작성자가 맞는지 확인 부탁드립니다.',
                }).then(function () {
                    window.location.reload();
                });
            }
        });
    }

    // 댓글 작성하기
    function createComment(commentUrl) {
        const token = Cookies.get('Authorization');
        const commentContent = document.getElementById("InputContent").value();

        console.log("댓글 작성 버튼 클릭 : 내용 -" + commentContent);

        $.ajax({
            url: commentUrl,
            type: "POST",
            dataType: "json",
            headers: {              // Http header
                "Content-Type": "application/json",
                "Authorization": token
            },
            data: JSON.stringify({
                content: commentContent
            }),
            contentType: "application/json",
            success: function (data) {
                Swal.fire({
                        icon: 'success',
                        title: '작성 성공',
                        text: '댓글 작성이 성공적으로 완료되었습니다.'
                    }
                ).then(function () {
                    window.location.reload();
                })
            },
            error: function (error) {
                Toast.fire({
                    icon: 'error',
                    title: '작성 오류',
                    text: '댓글 작성에 실패했습니다. 로그인 후에 시도부탁드립니다.',
                }).then(function () {
                    window.location.href = "/api/user/login-page"
                });
            }
        });
    }

</script>
</html>

