<!DOCTYPE HTML>
<html lang="ko">
<head>
    <title>너의 의견은.</title>
    <link rel="shortcut icon" href="#">

    <!-- ajax , cookies 사용 lib -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"
            integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <!-- ajax , cookies 사용 lib -->

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    <link rel='stylesheet' href="/css/votestyle.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="application/x-javascript"> addEventListener("load", function () {
        setTimeout(hideURLbar, 0);
    }, false);

    function hideURLbar() {
        window.scrollTo(0, 1);
    } </script>

    <!--    Button css-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
    <!--    Button css-->

    <!----webfonts---->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700,800' rel='stylesheet' type='text/css'>
    <!----//webfonts---->
    <!---start-click-drop-down-menu----->
    <script src="/js/single-page/jquery.min.js"></script>
    <!----//End-dropdown--->

    <style type="text/css">
        a.list-group-item {
            height: auto;
            min-height: 220px;
        }

        a.list-group-item.active small {
            color: #fff;
        }

        a.list-group-item .vs-title {
            font-size: 110px;
        }

        .fa {
            font-size: 100px;
            color: #ffffff;
        }

        .social a {
            text-decoration: none;
        }

        .twitter {
            background-color: #00acee;
            border-radius: 4px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .facebook-like {
            background-color: #3b5998;
            border-radius: 4px;
            margin-top: -3px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .media {
            padding: 10px;
        }
    </style>

</head>

<body>
<div class="header">
    <div class="wrap">

        <div class="logo">
            <button type="button" class="btn btn-secondary" onclick="location.href='/'" style="margin: 20px;">
                Back
            </button>
        </div>

        <div class="clear"></div>
    </div>
</div>
<!---//End-header---->
<!---start-content---->
<div class="content" style="background: url('https://images3.alphacoders.com/764/764967.png');">
    <div class="wrap">
        <div class="single-page">
            <div class="single-page-artical">
                <div class="artical-content">


                    <div class="row form-group">
                        <div class="col-md-12" style="width: 95%;text-align: left;">
                            <div>
                                <span class="text-black h4">닉네임: <label class="text-black h4" id="userinfo"></label></span>
                            </div>
                            <div style="float:right;">
                                <label class="text-black h4">작성일자</label> :
                                <label class="text-black h4" th:text="${#temporals.format(post.modifiedAt, 'yyyy-MM-dd HH:mm:ss')}"></label>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="container bootstrap snippets bootdey">
                            <div class="row">
                                <div class="well" style="width: 85%;">
                                    <h1 class="text-center text-primary">
                                        <b><span th:text="${post.title}"></span></b>
                                    </h1>
                                    <br/>
                                    <p th:text="${post.content}"></p>

                                    <div class="list-group">
                                        <a href="#" class="list-group-item">
                                            <div class="col-md-3">
                                                <div class="media col-md-12 twitter">
                                                    <figure class="pull-left">
                                                        <i class="fa fa-twitter"></i>
                                                    </figure>
                                                </div>
                                                <div class="media col-md-12">
                                                    <button type="button" class="btn btn-default btn-lg btn-block"><span
                                                            th:text="${post.opinionA}"></span></button>
                                                    <button type="button" class="btn btn-default btn-lg btn-block"><span
                                                            th:text="${post.opinionACnt}"></span></button>

                                                </div>
                                            </div>
                                            <div class="col-md-6 text-center">
                                                <h1 class="vs-title">VS</h1>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="media col-md-12 facebook-like">
                                                    <figure class="pull-left">
                                                        <i class="fa fa-facebook"></i>
                                                    </figure>
                                                </div>
                                                <div class="media col-md-12">
                                                    <button type="button" class="btn btn-default btn-lg btn-block"><span
                                                            th:text="${post.opinionB}"></span></button>
                                                    <button type="button" class="btn btn-default btn-lg btn-block"><span
                                                            th:text="${post.opinionBCnt}"></span></button>

                                                </div>
                                            </div>
                                        </a>
                                    </div>
                                </div>
                                <div style="width: 50%;">
                                    <button type="button" class="btn btn-secondary" id="editBtn" style="margin-left: 20px;float: right;">수정</button>
                                    <button type="button" class="btn btn-secondary" id="deleteBtn" style="margin-left: 20px;float: right;">삭제</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="clear"></div>
            </div>
            <!---start-comments-section--->
            <div class="comment-section">
                <div class="grids_of_2">
                    <h2>Comments</h2>
                    <div class="grids_of_2" id="comment">

                    </div>
                    <div class="artical-commentbox">
                        <h2>Leave a Comment</h2>
                        <div class="table-form">
                            <form action="#" method="post" name="post_comment">
                                <div>
                                    <label>Name<span>*</span></label>
                                    <h4 id="loginUserName"></h4>
                                </div>
                                <div>
                                    <label>Your Comment<span>*</span></label>
                                    <textarea id="userComment" name="content"> </textarea>
                                </div>
                            </form>
                            <input type="submit" value="submit" onclick="insert()"/>

                        </div>
                        <div class="clear"></div>
                    </div>
                </div>
            </div>
            <!---//End-comments-section--->
        </div>
    </div>
</div>
<!----start-footer--->
<div class="footer">
    <p>Design by <a href="http://w3layouts.com/">W3layouts</a></p>
</div>
<!----//End-footer--->
<!---//End-wrap---->
</body>

<script th:inline="javascript">
    $(document).ready(function () {
        const token = Cookies.get('Authorization');

        if(token) {
            $.ajaxPrefilter(function (options, originalOptions, jqXHR) {
                jqXHR.setRequestHeader('Authorization', token);
            });
            getUser(token);
        }else {
            console.log('로그인이 안 되어있습니다.');
        }


        const postId = [[${post.id}]];
        const nickname = [[${post.nickname}]];
        const username = [[${post.username}]];
        const commentUrl = "/api/posts/"+ postId + "/comment";
        // console.log(commentUrl)

        //아이디 암호화 함수
        function maskingName() {
            // console.log(username)
            if (username.length >= 8) {
                return (
                    username.slice(0, 3) +
                    "*".repeat(Math.max(0, username.length - 5)) +
                    username.slice(-3)
                );
            } else {
                return (
                    username.slice(0, 2) +
                    "*".repeat(Math.max(0, username.length - 3)) +
                    username.slice(-1)
                );
            }
        }

        const maskedUsername = maskingName(username);

        $('#userinfo').html(nickname +"(" + maskedUsername + ")")

    })


        function getUser(token) {
            // console.log(token);
            const editBtn = document.getElementById('editBtn');
            const deleteBtn = document.getElementById('deleteBtn');

            const payload = JSON.parse(atob(token.split(".")[1]));
            const loginUsername = payload.sub; // 로그인한 id

            const writerUsername = [[${post.username}]];
            // console.log(writerUsername);

            $('#loginUserName').text(loginUsername)

            // 게시글 작성자일 경우
            if (loginUsername === writerUsername) {
                // 수정, 삭제 버튼 활성화
                editBtn.style.display = 'block';
                deleteBtn.style.display = 'block';
            } else {
                // 수정, 삭제 버튼 활성화
                editBtn.style.display = 'none';
                deleteBtn.style.display = 'none';
            }
        }

        function getLoginUser(token){
            const payload = JSON.parse(atob(token.split(".")[1]));
           return payload.sub; // 로그인한 id
        }



    const post = [[${post}]];
    console.log("post",post);

    for( var i =0;  i < post['commentResponseDtoList'].length; i++){
        let temp_html =
                `<div class="grid1_of_2" id="${post['commentResponseDtoList'][i].id}">
                            <div class="grid_img">
                                <a href=""><img src="" alt=""></a>
                            </div>
                            <div class="grid_text">
                                <h4 class="style1 list"><a href="#">${post['commentResponseDtoList'][i].username}</a></h4>
                                <h3 class="style">${post['commentResponseDtoList'][i].modifiedAt}</h3>
                                <p class="para top"> ${post['commentResponseDtoList'][i].content}</p>
                                <a id="testid" class="btn1" onclick="updateComment(${post['commentResponseDtoList'][i].id})">수정</a>
                                <a class="btn1" onclick="deleteComment(${post['commentResponseDtoList'][i].id})">삭제</a>
                            </div>
                            <div class="clear"></div>
                 </div>`;

        $('#comment').append(temp_html);
    }
    function insert(){

        $.ajax({
            type: "POST",
            url: `/api/posts/${post.id}/comment`,
            contentType: "application/json",
            data: JSON.stringify({content: $('#userComment').val()}),
        })
            .done(function (response, status, xhr) {
                console.log("resultL",response['result']);
                let temp_html =
                    `  <div class="grid1_of_2" id="${response['result'].id}" >
                            <div class="grid_img">
                                <a href=""><img src="" alt=""></a>
                            </div>
                            <div class="grid_text">
                                <h4 class="style1 list"><a href="#">${response['result'].username}</a></h4>
                                <h3 class="style">${response['result'].modifiedAt}</h3>
                                <p class="para top"> ${response['result'].content}</p>
                                <a id="testid" class="btn1" onclick="updateComment(${response['result'].id})">수정</a>
                                <a class="btn1" onclick="deleteComment(${response['result'].id})">삭제</a>
                            </div>
                            <div class="clear"></div>
                        </div>`;

                $('#comment').append(temp_html);
                $('#userComment').val('');

                window.location.href = `/api/post/detail-page/${post.id}`;

            })
            .fail(function (jqXHR, textStatus) {

            });
    }
    function deleteComment(id){

        $.ajax({
            type: "DELETE",
            url: `/api/comments/${id}`,
            contentType: "application/json",
        })
            .done(function (response, status, xhr) {
                    alert("삭제완료")
                window.location.href = `/api/post/detail-page/${post.id}`;
            })
            .fail(function (jqXHR, textStatus) {
                    alert("작성자가 다릅니다.")
                window.location.href = `/api/post/detail-page/${post.id}`;
            });
    }


    function updateComment(id){

        //다시 불러오기
        $.ajax({
            type: "GET",
            url: `/api/post/detail-page/${post.id}`,
            contentType: "application/json",
        })
            .done(function (response, status, xhr ) {
                for(var i = 0; i<post['commentResponseDtoList'].length;i++){


                    if(post['commentResponseDtoList'][i].id == id){

                        //작성자 확인
                        if(`${post.username}` != `${post['commentResponseDtoList'][i].username}`){
                            alert("작성자가 아닙니다.");
                            window.location.href = `/api/post/detail-page/${post.id}`;

                        }

                        //비우기
                        const node = document.getElementById(`${id}`);
                        node.remove();

                        let temp_html =
                            `  <div class="grid1_of_2" id="${post['commentResponseDtoList'][i].id}" >
                                    <div class="grid_img">
                                        <a href=""><img src="" alt=""></a>
                                    </div>
                                    <div class="grid_text">
                                        <h4 class="style1 list"><a href="#">${post['commentResponseDtoList'][i].username}</a></h4>
                                        <h3 class="style">${post['commentResponseDtoList'][i].modifiedAt}"</h3>
                                        <p class="para top"><input id="input" value="${post['commentResponseDtoList'][i].content}"/></p>
                                        <a class="btn1" onclick="update(${post['commentResponseDtoList'][i].id}, $('#input').val())">수정</a>
                                        <a class="btn1" onclick="deleteComment(${post['commentResponseDtoList'][i].id})">삭제</a>
                                    </div>
                                    <div class="clear"></div>
                                </div>`;


                        $('#comment').find($("a[id^='testid']")).empty()
                        $('#comment').append(temp_html);
                    }

                }


            })
            .fail(function (jqXHR, textStatus) {

            });
    }

    function update(id,value){

        $.ajax({
            type: "PUT",
            url: `/api/comments/${id}`,
            contentType: "application/json",
            data: JSON.stringify({content: value}),
        })
            .done(function (response, status, xhr) {
                alert("수정완료")
                window.location.href = `/api/post/detail-page/${post.id}`;
            })
            .fail(function (jqXHR, textStatus) {
                alert("작성자가 다릅니다.")
                window.location.href = `/api/post/detail-page/${post.id}`;
            });

    }


</script>
</html>

