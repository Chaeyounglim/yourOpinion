<!--
Author: W3layouts
Author URL: http://w3layouts.com
License: Creative Commons Attribution 3.0 Unported
License URL: http://creativecommons.org/licenses/by/3.0/
-->
<!DOCTYPE HTML>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>

    <link rel="shortcut icon" href="#">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
            integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"
            integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS"
            crossorigin="anonymous"></script>
    <link href="https://hangeul.pstatic.net/hangeul_static/css/NanumAJumMaJaYu.css" rel="stylesheet">
    <title>메인 페이지</title>
    <link href="/css/style.css" rel='stylesheet' type='text/css'/>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"
            integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <script src="/js/jquery.imagesloaded.js"></script>
    <script src="/js/jquery.wookmark.js"></script>
    <script type="text/javascript"></script>


    <script type="application/x-javascript"> addEventListener("load", function () {
        setTimeout(hideURLbar, 0);
    }, false);

    function hideURLbar() {
        window.scrollTo(0, 1);
    } </script>
    <!----webfonts---->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700,800' rel='stylesheet' type='text/css'>
    <!----//webfonts---->
    <!-- Global CSS for the page and tiles -->
    <link rel="stylesheet" href="css/main.css">
    <!-- //Global CSS for the page and tiles -->
    <!---start-click-drop-down-menu----->
<!--    <script src="js/jquery.min.js"></script>-->
    <!----start-dropdown--->
    <script type="text/javascript">
        var $ = jQuery.noConflict();
        $(function () {
            $('#activator').click(function () {
                $('#box').animate({'top': '0px'}, 500);
            });
            $('#boxclose').click(function () {
                $('#box').animate({'top': '-700px'}, 500);
            });
        });
        $(document).ready(function () {
            //Hide (Collapse) the toggle containers on load
            $(".toggle_container").hide();
            //Switch the "Open" and "Close" state per click then slide up/down (depending on open/close state)
            $(".trigger").click(function () {
                $(this).toggleClass("active").next().slideToggle("slow");
                return false; //Prevent the browser jump to the link anchor
            });

        });
    </script>
    <!----//End-dropdown--->
    <!---//End-click-drop-down-menu----->
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>

</head>
<body>
<!---start-wrap---->
<!---start-header---->
<div class="header">
    <div class="wrap">
        <div class="logo">
            <div class="logo" style="font-family: 'NanumAJumMaJaYu'; bottom: 10px; color: white; font-size: 50px">너의
                이름은.
            </div>
        </div>
        <!--    <div class="nav-icon">-->
        <!--      <a href="#" class="right_bt" id="activator"><span> </span> </a>-->
        <!--    </div>-->
        <div class="userinfo">
            <div class="user">
                <ul>
                    <button type="button" class="btn btn-secondary" id="login" onclick="location.href='/api/user/login-page'">로그인&회원가입</button>
<!--                    <li><a href="/api/user/login-page" id="login"><span>로그인&회원가입</span></a></li>-->

                    <button type="button" class="btn btn-secondary" id="profile" onclick="location.href='/api/user/profile-page'"></button>
                    <button type="button" class="btn btn-secondary" id="logout" onclick="logout()">로그아웃</button>
<!--                    <li><a href="" ><span id="profile"></span></a></li>-->
<!--                    <li><a href="#" id="logout" onclick="logout()"><span>로그아웃</span></a></li>-->
                </ul>
            </div>
        </div>
        <div class="clear"></div>
    </div>
</div>
<!---//End-header---->
<!---start-content---->
<div class="content">

    <div class="wrap">
        <div id="main" role="main">
            <ul id="tiles">
                <div id="loadingMessage" class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">게시물을 불러오는 중...</span>
                </div>
            </ul>
        </div>
    </div>
</div>
<!---//End-content---->
<!----wookmark-scripts---->


<div class="footer">
    <button type="button" class="btn btn-secondary" onclick="location.href='/api/post/write-page'">작성하기</button>
</div>
</body>
</html>
<script>
    $(document).ready(function () {
        const apiUrl = "/api/posts";

        // 쿠키값 가져오기
        let token = Cookies.get('Authorization');

        function getUser(token) {
            const payload = JSON.parse(atob(token.split(".")[1]));
            const username = payload.sub;
            console.log(username);
            $("#profile").text(username);
        }

        if(token){
            //쿠키 있을때
            getUser(token)
            $("#login").hide();
        }else {
            //쿠키 없을때
            $("#profile").hide();
            $("#logout").hide();
        }

        $.ajax({
            url: apiUrl,
            type: "GET",
            dataType: "json",
            success: function (data) {
                // $("#loadingMessage").hide();
                // 서버에서 데이터를 가져오면 로딩 메시지를 숨기고 게시물을 동적으로 생성합니다.
                displayPosts(data.result); // 서버에서 받은 데이터로 게시물 생성
            },
            error: function (error) {
                // 데이터 가져오기에 실패한 경우 에러 메시지를 출력합니다.
                console.error("Error fetching posts:", error);
                $("#loadingMessage").text("게시물을 불러오는 데 실패했습니다.");
            },
        });
    });

    function displayPosts(posts) {
        const $tiles = $('#tiles'); // #tiles 요소를 찾습니다.
        let postElements = '';
        posts.forEach((post) => {
            postElements += createPostElement(post);
        });
        $tiles.html(postElements); // #tiles 요소에 게시물 요소들을 추가합니다.

        (function ($) {
            var $tiles = $('#tiles'),
                $handler = $('li', $tiles),
                $main = $('#main'),
                $window = $(window),
                $document = $(document),
                options = {
                    autoResize: true, // This will auto-update the layout when the browser window is resized.
                    container: $main, // Optional, used for some extra CSS styling
                    offset: 20, // Optional, the distance between grid items
                    itemWidth: 280 // Optional, the width of a grid item
                };

            /**
             * Reinitializes the wookmark handler after all images have loaded
             */
            function applyLayout() {
                $tiles.imagesLoaded(function () {
                    // Destroy the old handler
                    if ($handler.wookmarkInstance) {
                        $handler.wookmarkInstance.clear();
                    }

                    // Create a new layout handler.
                    $handler = $('li', $tiles);
                    $handler.wookmark(options);
                });
            }

            /**
             * When scrolled all the way to the bottom, add more tiles
             */
            // 스크롤 이벤트를 처리하는 함수
            function onScroll() {
                // 스크롤이 끝에 도달하고, 이미 스크롤 이벤트가 처리 중인 경우에만 실행
                var winHeight = window.innerHeight ? window.innerHeight : $window.height(),
                    closeToBottom = ($window.scrollTop() + winHeight > $document.height() - 100);

                if (closeToBottom && !scrollEventProcessing) {
                    // 스크롤 이벤트가 처리 중인 상태를 저장
                    scrollEventProcessing = true;
                    // 새로운 게시물을 추가하는 비동기 요청 수행
                    loadMorePosts(function () {
                        // 비동기 요청이 완료된 후에 스크롤 이벤트 처리 상태를 초기화
                        scrollEventProcessing = false;
                    });
                }
            }

            // 새로운 게시물을 추가하는 비동기 함수 (여기서는 예시로 빈 함수로 처리)
            function loadMorePosts(callback) {
                // TODO: 실제로 서버에서 새로운 게시물을 가져와서 $tiles에 추가하는 로직을 구현해야 합니다.
                // 이 함수가 비동기 요청이므로, 콜백 함수를 이용해 스크롤 이벤트 처리 상태를 초기화.
                // 즉, loadMorePosts 함수가 완료되면 콜백 함수가 실행.
                // 콜백 함수를 사용하여 스크롤 이벤트 처리 상태를 초기화.
                callback();
            }

            // Call the layout function for the first time
            applyLayout();

            // Capture scroll event.
            $window.bind('scroll.wookmark', onScroll);
        })(jQuery);
    }

    function createPostElement(post) {
        return `
      <li onclick="detailPost(${post.id})">
        <div class="post-info">
          <div class="post-basic-info">
            <h3><a href="#" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${post.title}</a></h3>
            <span><a href="#">작성자:${post.username}</a></span>
            <p style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${post.content}</p>
          </div>
          <div class="post-info-rate-share">
            <div>
              <p class="txt-center">댓글수 : ${post.commentList}</p>
              <p class="txt-center">좋아요 수 : </p>
            </div>
            <div class="clear"></div>
          </div>
        </div>
      </li>
    `;
    }

    function detailPost(postId) {
        window.location.href = `/api/post/detail-page/${postId}`;
    }

    function logout(){
        Cookies.remove('Authorization', {path: '/'});
        window.location.href = '/api/user/login-page'
    }


</script>

