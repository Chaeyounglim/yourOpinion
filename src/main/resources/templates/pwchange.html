<!doctype html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
            integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"
            integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS"
            crossorigin="anonymous"></script>
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">

    <title>비밀번호 수정</title>
    <style>
        body {
            background-color: var(--white);
            background: url("https://images5.alphacoders.com/737/737385.jpg");
            background-attachment: fixed;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            display: grid;
            height: 100vh;
            font-family: 'Jua', sans-serif;
        }

        table {
            margin: auto;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .material-symbols-outlined {
            position: relative;
            left: 20px;
            top: 20px;
            color: white;
            transition: transform 0.3s;
            font-variation-settings: 'FILL' 0,
            'wght' 600,
            'GRAD' 0,
            'opsz' 48
        }

        .material-symbols-outlined:hover {
            transform: scale(1.1);
            font-variation-settings: 'FILL' 1,
            'wght' 700,
            'GRAD' 0,
            'opsz' 48
        }
    </style>
</head>

<body>
<div>
    <a href="/">
        <span class="material-symbols-outlined">
            home
        </span>
    </a>
</div>
<div class="text-center container">
    <form id="passwordForm" name="infobox" style="margin-right: 2%;">
        <h1 style="color: white"><span class="myid"></span>님의 비밀번호 수정입니다.</h1>
        <br>
        <table>
            <tr>
                <th class="p-3" style="color: white">현재 비밀번호</th>
                <td>
                    <input type="password" id="memberPw1" class="inputbox form-control text-center"
                           aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">
                </td>
            </tr>
            <tr>
                <th class="p-3" style="color: white">새로운 비밀번호</th>
                <td>
                    <input type="password" id="memberPw2" class="inputbox form-control text-center"
                           aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">
                </td>
            </tr>
            <tr>
                <th class="p-3" style="color: white">새로운 비밀번호 확인</th>
                <td>
                    <input type="password" id="memberPw3" class="inputbox form-control text-center"
                           aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">
                </td>
            </tr>
        </table>
        <button type="button" id="pwUpdate" class="btn btn-primary btn"
                style="margin-left: 2rem; margin-top: 10px;" onclick="">변경
        </button>
        <button type="button" id="cancel" class="btn btn-secondary btn"
                style="margin-left: 10px; margin-top: 10px;">취소
        </button>
    </form>
</div>
</body>

<script>
    const Toast = Swal.mixin({
        toast: true,
        position: 'center-center',
        showConfirmButton: false,
        timer: 5000,
        timerProgressBar: true,
        didOpen: (toast) => {
            toast.addEventListener('mouseenter', Swal.stopTimer)
            toast.addEventListener('mouseleave', Swal.resumeTimer)
        }
    })

    $('#cancel').click(function () {
        window.location.href = "/api/user/profile-page";
    });

    $(document).ready(function () {
        // Cookie에서 JWT를 가져옴
        const token = Cookies.get('Authorization');
        if (token) {
            // 모든 AJAX 요청에 헤더에 JWT를 포함하기 위한 설정
            $.ajaxPrefilter(function (options, originalOptions, jqXHR) {
                jqXHR.setRequestHeader('Authorization', token);
            });

            getid(token)

            // 사용자 프로필 정보를 가져옴
            $('#pwUpdate').click(function () {
                for (let i = 1; i < 3; i++) {
                    const pw = $("#memberPw" + i).val()
                    const num = pw.search(/[0-9]/g);
                    const eng = pw.search(/[a-z]/ig);
                    const spe = pw.search(/[`~!@@#$%^&*|₩₩₩'₩";:₩/?]/gi);

                    if (pw.length < 8 || pw.length > 20) {
                        Swal.fire({
                            icon: 'warning',
                            title: '비밀번호 입력오류',
                            text: '8자리 ~ 20자리 이내로 입력해주세요.',
                        });
                        return false;
                    }
                    if (pw.search(/\s/) != -1) {
                        Swal.fire({
                            icon: 'warning',
                            title: '비밀번호 입력오류',
                            text: '비밀번호는 공백 없이 입력해주세요.',
                        });
                        return false;
                    }
                    if (num < 0 || eng < 0 || spe < 0) {
                        Swal.fire({
                            icon: 'warning',
                            title: '비밀번호 입력오류',
                            text: '영문,숫자, 특수문자를 혼합하여 입력해주세요.',
                        });
                        return false;
                    }
                }

                if ($('#memberPw1').val() == '') {
                    Swal.fire({
                        icon: 'warning',
                        title: '비밀번호 미입력',
                        text: '현재 비밀번호를 입력해주세요.',
                    });
                    $("#memberPw1").focus();
                    return false
                }
                if ($('#memberPw2').val() == '') {
                    Swal.fire({
                        icon: 'warning',
                        title: '비밀번호 미입력',
                        text: '새로운 비밀번호를 입력해주세요.',
                    });
                    $("#memberPw1").focus();
                    return false
                }
                if ($('#memberPw3').val() == '') {
                    Swal.fire({
                        icon: 'warning',
                        title: '비밀번호 미입력',
                        text: '새로운 비밀번호 확인을 입력해주세요.',
                    });
                    $("#memberPw1").focus();
                    return false
                }
                if ($("#memberPw2").val() != $("#memberPw3").val()) {
                    Swal.fire({
                        icon: 'warning',
                        title: '비밀번호 미입력',
                        text: '변경비밀번호가 일치하지 않습니다.',
                    });
                    $("#memberPw3").focus();
                    return false
                }
                updatepassword(token);
            });
        } else {
            Toast.fire({
                icon: 'error',
                title: '토큰 오류',
                text: '프로필 정보를 가져오는 데 실패했습니다. 잠시후 로그인 화면으로 되돌아갑니다.',
            }).then(function () {
                window.location.href = "/api/user/login-page"
            });
        }
    });

    const getid = (token) => {
        // JWT 토큰 디코딩하여 페이로드 추출
        const payload = JSON.parse(atob(token.split(".")[1]));
        // console.log(payload)

        // 예시 {sub: 'qw12345611', auth: 'USER', exp: 1689745728, iat: 1689742128}
        // 그중 username을 추출해야하니 sub를 가져옴. 만약 관리자 확인이면 auth를 가져올듯.
        const username = payload.sub;

        $('.myid').html(username);
    }


    // 프로필 정보 업데이트하기
    function updatepassword(token) {
        const checkPassword = $('#memberPw1').val();
        const newPassword = $('#memberPw3').val();

        // console.log(token)
        // JWT 토큰 디코딩하여 페이로드 추출
        const payload = JSON.parse(atob(token.split(".")[1]));
        // console.log(payload)

        // 예시 {sub: 'qw12345611', auth: 'USER', exp: 1689745728, iat: 1689742128}
        // 그중 username을 추출해야하니 sub를 가져옴. 만약 관리자 확인이면 auth를 가져올듯.
        const username = payload.sub;
        // console.log(username)
        Swal.fire({
            title: '비밀번호를 수정하시겠습니까?',
            text: "확인을 누르시면 수정이 완료됩니다.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '확인',
            cancelButtonText: '취소'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: "/api/password",
                    type: "PUT",
                    dataType: "json",
                    data: JSON.stringify(
                        {
                            checkPassword: checkPassword,
                            newPassword: newPassword,
                            username: username
                        }
                    ),
                    contentType: "application/json",
                    success: function (data) {
                        Toast.fire({
                            icon: 'success',
                            title: '수정 성공',
                            text: '비밀번호가 성공적으로 업데이트되었습니다. 잠시후 프로필수정 페이지로 되돌아갑니다.',
                        }).then(function () {
                            window.location.href = "/api/user/profile-page"
                        })
                    },
                    error: function (error) {
                        if (error.responseJSON && error.responseJSON.errorMessage) {
                            const errorMessage = error.responseJSON.errorMessage;
                            console.log("에러 메시지:", errorMessage);
                            Swal.fire(
                                {
                                    icon: 'warning',
                                    title: '수정 실패',
                                    text: errorMessage
                                }
                            )
                        } else {
                            const errorMessage = error.responseJSON.errorMessage;
                            Swal.fire(
                                {
                                    icon: 'warning',
                                    title: '수정 실패',
                                    text: errorMessage
                                }
                            )
                            console.error("비밀번호 변경에 실패했습니다.", errorMessage);
                        }

                    }
                });
            }
        })
    }
</script>

</html>